<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Alvasco Procurement System Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .header { text-align: center; margin-bottom: 30px; color: #1976d2; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { background: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #1565c0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .result { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f5f5f5; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Alvasco Procurement System</h1>
            <p>Digital transformation of Excel-based operations</p>
        </div>

        <!-- Authentication -->
        <div class="section">
            <h2>Authentication</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" value="admin@alvasco.com">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" value="admin123">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn" onclick="logout()">Logout</button>
            <div id="userInfo" class="hidden">
                <p><strong>Logged in as:</strong> <span id="userName"></span> (<span id="userRole"></span>)</p>
            </div>
        </div>

        <!-- Products -->
        <div class="section">
            <h2>Products</h2>
            <button class="btn" onclick="loadProducts()">Load Products</button>
            <div id="productsResult"></div>
        </div>

        <!-- Pricing Calculator -->
        <div class="section">
            <h2>Pricing Calculator</h2>
            <div class="form-group">
                <label>Select Product:</label>
                <select id="productSelect">
                    <option value="">Select a product...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quantity:</label>
                <input type="number" id="quantity" value="100" min="1">
            </div>
            <div class="form-group">
                <label>Shipping Method:</label>
                <select id="shippingMethod">
                    <option value="DHL">DHL (Air)</option>
                    <option value="SEA">Sea Freight</option>
                </select>
            </div>
            <button class="btn" onclick="calculatePricing()">Calculate Pricing</button>
            <div id="pricingResult"></div>
        </div>

        <!-- Clients -->
        <div class="section">
            <h2>Clients</h2>
            <button class="btn" onclick="loadClients()">Load Clients</button>
            <div id="clientsResult"></div>
        </div>

        <!-- Proposals -->
        <div class="section">
            <h2>Proposals</h2>
            <button class="btn" onclick="loadProposals()">Load Proposals</button>
            <div id="proposalsResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://alvasco-procurement-backend.onrender.com/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        if (authToken) checkAuth();

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    showUserInfo();
                    loadProducts();
                } else logout();
            } catch (error) {
                logout();
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    showUserInfo();
                    loadProducts();
                    showResult('productsResult', 'Login successful!', 'success');
                } else {
                    showResult('productsResult', `Login failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('productsResult', `Login error: ${error.message}`, 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showUserInfo() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            document.getElementById('userInfo').classList.remove('hidden');
        }

        async function loadProducts() {
            if (!authToken) {
                showResult('productsResult', 'Please login first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    displayProducts(data.products);
                    populateProductSelect(data.products);
                } else {
                    showResult('productsResult', `Failed to load products: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('productsResult', `Error loading products: ${error.message}`, 'error');
            }
        }

        function displayProducts(products) {
            let html = '<h3>Products (' + products.length + ')</h3>';
            if (products.length > 0) {
                html += '<table class="table"><tr><th>Name</th><th>Category</th><th>Price (USD)</th><th>DHL Price (BBD)</th><th>SEA Price (BBD)</th></tr>';
                products.forEach(product => {
                    const dhlPrice = product.calculatedPricing?.unitPriceLanded?.byDHL || 0;
                    const seaPrice = product.calculatedPricing?.unitPriceLanded?.bySEA || 0;
                    html += `<tr><td>${product.name}</td><td>${product.category}</td><td>$${product.excelStructure.price.value}</td><td>BBD$${dhlPrice.toFixed(2)}</td><td>BBD$${seaPrice.toFixed(2)}</td></tr>`;
                });
                html += '</table>';
            } else {
                html += '<p>No products found.</p>';
            }
            document.getElementById('productsResult').innerHTML = html;
        }

        function populateProductSelect(products) {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Select a product...</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product._id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        }

        async function calculatePricing() {
            if (!authToken) {
                showResult('pricingResult', 'Please login first', 'error');
                return;
            }

            const productId = document.getElementById('productSelect').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const shippingMethod = document.getElementById('shippingMethod').value;

            if (!productId) {
                showResult('pricingResult', 'Please select a product', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products/${productId}/calculate-pricing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ quantity, shippingMethod })
                });

                const data = await response.json();
                if (response.ok) {
                    displayPricingResult(data);
                } else {
                    showResult('pricingResult', `Calculation failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('pricingResult', `Error calculating pricing: ${error.message}`, 'error');
            }
        }

        function displayPricingResult(data) {
            let html = '<h3>Pricing Calculation Result</h3>';
            html += '<div class="result success">';
            html += `<p><strong>Product:</strong> ${data.productName}</p>`;
            html += `<p><strong>Quantity:</strong> ${data.quantity}</p>`;
            html += `<p><strong>Shipping Method:</strong> ${data.shippingMethod}</p>`;
            html += `<p><strong>Unit Price:</strong> BBD$${data.pricing.unitPriceBBD.toFixed(2)}</p>`;
            html += `<p><strong>Total Price:</strong> BBD$${data.pricing.totalPriceBBD.toFixed(2)}</p>`;
            html += `<p><strong>Gross Profit:</strong> BBD$${data.pricing.totalGrossProfitBBD.toFixed(2)}</p>`;
            html += `<p><strong>Lead Time:</strong> ${data.pricing.leadTime || '15'} days</p>`;
            html += '</div>';
            document.getElementById('pricingResult').innerHTML = html;
        }

        async function loadClients() {
            if (!authToken) {
                showResult('clientsResult', 'Please login first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/clients`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    displayClients(data.clients);
                } else {
                    showResult('clientsResult', `Failed to load clients: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('clientsResult', `Error loading clients: ${error.message}`, 'error');
            }
        }

        function displayClients(clients) {
            let html = '<h3>Clients (' + clients.length + ')</h3>';
            if (clients.length > 0) {
                html += '<table class="table"><tr><th>Name</th><th>Company</th><th>Email</th><th>Phone</th><th>Business Type</th></tr>';
                clients.forEach(client => {
                    html += `<tr><td>${client.name}</td><td>${client.company}</td><td>${client.email}</td><td>${client.phone}</td><td>${client.businessType}</td></tr>`;
                });
                html += '</table>';
            } else {
                html += '<p>No clients found.</p>';
            }
            document.getElementById('clientsResult').innerHTML = html;
        }

        async function loadProposals() {
            if (!authToken) {
                showResult('proposalsResult', 'Please login first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/proposals`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    displayProposals(data.proposals);
                } else {
                    showResult('proposalsResult', `Failed to load proposals: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('proposalsResult', `Error loading proposals: ${error.message}`, 'error');
            }
        }

        function displayProposals(proposals) {
            let html = '<h3>Proposals (' + proposals.length + ')</h3>';
            if (proposals.length > 0) {
                html += '<table class="table"><tr><th>Proposal #</th><th>Client</th><th>Title</th><th>Total</th><th>Status</th><th>Created</th></tr>';
                proposals.forEach(proposal => {
                    html += `<tr><td>${proposal.proposalNumber}</td><td>${proposal.client?.name || 'N/A'}</td><td>${proposal.title}</td><td>BBD$${proposal.totals?.subtotal?.toFixed(2) || '0.00'}</td><td>${proposal.status}</td><td>${new Date(proposal.createdAt).toLocaleDateString()}</td></tr>`;
                });
                html += '</table>';
            } else {
                html += '<p>No proposals found.</p>';
            }
            document.getElementById('proposalsResult').innerHTML = html;
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="result ${type}">${message}</div>`;
            }
        }
    </script>
</body>
</html>
